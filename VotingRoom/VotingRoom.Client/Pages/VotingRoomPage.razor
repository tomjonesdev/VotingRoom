@page "/{RoomId:guid}"
@rendermode InteractiveWebAssembly
@using Microsoft.AspNetCore.SignalR.Client
@using VotingRoom.Client.Components
@using VotingRoom.Client.Services
@using VotingRoom.Common.Enums
@using VotingRoom.Common.Models
@inject IJSRuntime JSRuntime
@inject IVotingService VotingService
@inject ClientStateProvider ClientState
@implements IAsyncDisposable

<PageTitle>Voting Room</PageTitle>

<h1>@ClientState.Room?.Name</h1>

@if (ClientState.CurrentUser is null)
{
    <MemberJoinForm RoomId="RoomId" />
}
else if (ClientState.Room is not null)
{
    <RoomHeading Voter="ClientState.CurrentUser" Room="ClientState.Room" />
    <VoteCards />
}

@code {
    [Parameter] public Guid RoomId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        /*
         * System.InvalidOperationException
            JavaScript interop calls cannot be issued during server-side static rendering, because the 
            page has not yet loaded in the browser. Statically-rendered components must wrap any JavaScript 
            interop calls in conditional logic to ensure those interop calls are not attempted during static 
            rendering.
         */
        var storageRoomIds = await JSRuntime.InvokeAsync<List<string>>("localStorage.getItem", "rooms");
        if (storageRoomIds.Contains(RoomId.ToString()))
        {
            Console.WriteLine("Unable to join room");
            return;
        }

        storageRoomIds.Add(RoomId.ToString());

        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "rooms", storageRoomIds);
        await VotingService.Connect();

        // TODO: Retrieve room name for subsequent users when they connect (i.e prior to submitting their name)
        VotingService.OnUserJoined += HandleUserJoined;
        VotingService.OnUpdateCurrentUser += HandleUpdateCurrentUser;
    }

    private void HandleUserJoined(Voter newUser)
    {
        InvokeAsync(() =>
        {
            ClientState.Room.Voters.Add(newUser);
            StateHasChanged();
        });
    }

    private void HandleUpdateCurrentUser(
        Room room,
        Voter updatedUser)
    {
        ClientState.Room = room;
        ClientState.CurrentUser = updatedUser;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        VotingService.OnUserJoined -= HandleUserJoined;
        VotingService.OnUpdateCurrentUser -= HandleUpdateCurrentUser;
    }
}
